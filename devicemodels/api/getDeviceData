/**
 * Get device data
 * @param {String} id: the identifier of the device to load
 * @param {String} field: optional, if defined, script only returns the latest value of this field in a device
 * @retun {Object} {field:value, etc.}
 */ 

var config =  require("../config");
var DEFAULT_CHANNEL = "responseChannel";

try {
 
  require("/modules/framr/Framr").init(this, {classPath: "modules/;"});
  import("devicemodels.demoApp.model.Car");
  import("agnes.VersionableDeviceRepositoryAdaptor");

  //check search criteria
  var params = {};
  if(request.body != null){
    params = request.body;
  }else if(request.parameters.body){
    params = request.parameters.body;
  }else {
    params = request.parameters;
  }
  
  if(typeof params == 'string' && params != null){
    try{
      params = JSON.parse(params);   
    }catch(e){
      return "INVALID OR MISSING PARAMETER";
    }
  }

  var id = params.id;
  if (!id){
    return "MISSING 'id' PARAMETER";;
  }

  var field = params.field;

  var adaptor = new VersionableDeviceRepositoryAdaptor();
  var deviceData = adaptor.load(id);
  
  if (field) {

    var output = {};
    output[field] = deviceData[field];
    var dev = {
      id: deviceData.id,
      cls: deviceData.cls      
    }
    
    dev[field] = deviceData[field];
    publishUpdate(dev);
    return output;
  }else {
    
    publishUpdate(deviceData);
    return deviceData;
  }
  
 
}catch(exception){
  
  var log = require("log"); 
  log.setLevel("info");
  log.error("Exception occured while invoking devicemodels/api/getDeviceData:\n" + JSON.stringify(exception));
  return {};
}

function publishUpdate(device) {
  
  /**
   * message = {id: deviceid.field, result: }
   * gauge, speedo, odo: result = value
   * charts (line, bar, ): result = [y, x, x]
   */
  
  var channel = config && config.channel ? config.channel : DEFAULT_UPDATE_CHANNEL;
  // var model = modelModule[device.cls];
  for (var key in device) {
    
    // var widgetObj = model ? model.attributes[key] : null;
    // var widgetType = widgetObj ? widgetObj.type : null;    
    if (["cls", "id", "vin", "make", "model", "year"].indexOf(key) < 0) {
      
      var msg = {};
      msg["id"] = ""+ device.id + "." + key;
      msg["result"] = device[key]; 
      publish(channel, JSON.stringify(msg));
    }    
  }  
}
